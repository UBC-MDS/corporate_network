<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <link type="text/css" rel="stylesheet" href="css/style.css"/>
    <script type="text/javascript" src="d3/d3.js"></script>
    <script type="text/javascript" src="d3/d3.layout.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>
    <script src="https://raw.githubusercontent.com/susielu/d3-legend/master/d3-legend.min.js"></script>
    <style type="text/css">
    

.node circle {
  cursor: pointer;
  fill: lightblue;
  stroke: GhostWhite;
  stroke-width: 1px;
}
.node text {
  font-size: 11px;
}
path.link {
  fill: none;
  stroke: #ccc;
  stroke-width: 1.5px;
}

.legend rect {
  fill:white;
  stroke:black;
  opacity:0.8;}

body {
  overflow-y: scroll;
  overflow-x: scroll;
}

/*
table.tableSection {
  display: table;
  width: 100%;
}

table.tableSection thead,
table.tableSection tbody {
  width: 100%;
}

table.tableSection thead {
  overflow-y: scroll;
  display: table;
  table-layout: fixed;
  width: calc(100% - 16px); // assuming scrollbar width as 16px 
}

table.tableSection tbody {
  overflow: auto;
  height: 150px;
  display: block;
}

table.tableSection tr {
  width: 100%;
  text-align: left;
  display: table;
  table-layout: fixed;
}
*/

thead th { 
  position: sticky; top: 0;
  background-color: white; 
}

.scrolltable {
    overflow-y:scroll;
    height: 200px;
} 

</style>
  </head>
  <body>
    
    <BR><BR>
	<font size="4">Corporate Network for 
		<b id="footer_text"></b>
		</a> <BR>
        <font size="4">Relationship Type: <b id="footer_metric"></b></font>,  <font size="4">Year: <b id="footer_year"></b></font>
	</font><BR><BR>
	<font size="4">
    <div class="dropdown">
        <button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">Relationship Type
        <span class="caret"></span></button>
        <ul class="dropdown-menu">
            <li><a id="competition" href="">Competition</a></li>
            <li><a id="ownership" href="">Ownership</a></li>
            <li><a id="agreement" href="">Agreements</a></li>
            <li><a id="legal" href="">Legal Suits</a></li>
            <li><a id="personal" href="">Personal Ties</a></li>
            <li><a id="full" href="">All Relationships</a></li>
        </ul>
    </div> 

    <div class="dropdown">
            <button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown" onclick="myAjax(populateYearMenu)">Filing Year
            <span class="caret"></span></button>
            <ul class="dropdown-menu" id="year-menu">
                <!-- <li><a id="2013" href="">2013</a></li>
                <li><a id="2014" href="">2014</a></li> -->
            </ul>
        </div> 

    <BR>
	<font id="hint" size="3" color="grey"><I>click circle to change the root</I></font>
        <!--div class="hint">click or option-click to expand or collapse</div-->

    </body>
    
    <body>
    <div id="body">
        <!-- might need to change this loading message-->
      <h2 align="center" id="loading_message_1">Data is loading... </h2>
      <div id="footer">
        <!--p id="footer_text2">d3.layout.tree</p>
        <div class="hint">click or option-click to expand or collapse</div-->
      </div>
    </div>
    <script type="text/javascript">
// get parameters 
function getParameterByName(name)
{
  name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
  var regexS = "[\\?&]" + name + "=([^&#]*)";
  var regex = new RegExp(regexS);
  var results = regex.exec(window.location.search);
  if(results == null)
    if (name == 'company'){
        return 'microsoft';
    }
    else if (name == "month"){
        return firstDayInPreviousMonth(new Date()).getMonth() + 1;
    }
    else if (name == "metric"){
        return "competition";
    }
    else if (name == "year"){
        return '2016';
    }
    else{
        return "";
    }
  else
    return decodeURIComponent(results[1].replace(/\+/g, " "));
}
function getJsonFileName(companyId){
	var json_path = "";
	var base_url = "";
	// Gene: get json data
	if (getParameterByName("metric") == "competition"){
		json_path = "./json.competition/converted/";
		base_url = "./local.html?metric=competition";
	}
	else if (getParameterByName("metric") == "ownership"){
		json_path = "./json.ownership/converted/";
		base_url = "./local.html?metric=ownership";
	}
	else if (getParameterByName("metric") == "agreement"){
		json_path = "./json.agreement/converted/";
		base_url = "./local.html?metric=agreement";
    }
  else if (getParameterByName("metric") == "legal"){
    json_path = "./json.legal/converted/";
		base_url = "./local.html?metric=legal";
	}
	else if (getParameterByName("metric") == "personal"){
		json_path = "./json.personal/converted/";
		base_url = "./local.html?metric=personal";
	}
  else if (getParameterByName("metric") == "full"){
		json_path = "./json.full/converted/";
		base_url = "./local_full.html?metric=full";
	}
	else {
		json_path = "./json/converted/";
		base_url = "./local.html?company=";
	}
  var companyJsonFile = json_path +year+"/" + companyId + ".json";
	console.log(companyJsonFile);
	return companyJsonFile;
}
var metric = "";
if (getParameterByName("metric") == "competition"){
	metric = "competition";
}
else if (getParameterByName("metric") == "ownership"){
	metric = "common ownership";
}
else if (getParameterByName("metric") == "agreement"){
  metric = "agreement";
}
else if (getParameterByName("metric") == "legal"){
  metric = "legal suit";
}
else if (getParameterByName("metric") == "personal"){
	metric = "personal connection";
}
  else if (getParameterByName("metric") == "full"){
	metric = "all relationships";
}
var year = getParameterByName("year");
// proximity
document.getElementById('competition').setAttribute('href', "./local.html?metric=competition&year="+ getParameterByName("year") +"&company=" + getParameterByName("company"));
document.getElementById('ownership').setAttribute('href', "./local.html?metric=ownership&year=" + getParameterByName("year") +"&company=" + getParameterByName("company"));
document.getElementById('agreement').setAttribute('href', "./local.html?metric=agreement&year=" + getParameterByName("year") +"&company=" + getParameterByName("company"));
document.getElementById('legal').setAttribute('href', "./local.html?metric=legal&year=" + getParameterByName("year") +"&company=" + getParameterByName("company"));
document.getElementById('personal').setAttribute('href', "./local.html?metric=personal&year=" + getParameterByName("year") +"&company=" + getParameterByName("company"));
document.getElementById('full').setAttribute('href', "./local_full.html?metric=full&year=" + getParameterByName("year") +"&company=" + getParameterByName("company"));


// added year
// document.getElementById('2013').setAttribute('href', "./local.html?metric=competition&year=2013&company=" + getParameterByName("company"))
// document.getElementById('2014').setAttribute('href', "./local.html?metric=competition&year=2014&company=" + getParameterByName("company"))
if ( check_json_exists_target() ) {
	var jsonData = $.ajax({
		url: getJsonFileName(getParameterByName("company")),
		data: "",
		dataType: "json",
		async: false
		}).responseText;
	jsonParsedData = JSON.parse(jsonData);
	//console.log(jsonParsedData["nodes"][0]);
	//console.log(jsonParsedData["nodes"]);
	var companyName = jsonParsedData["name"];
	//console.log(jsonParsedData);
	// change HTML title
	document.title = "Relationship Mapper for " + companyName;
	document.getElementById('footer_text').innerHTML = companyName;
    // capitalized relationship type
	document.getElementById('footer_metric').innerHTML = metric.charAt(0).toUpperCase() + metric.slice(1);
    document.getElementById('footer_year').innerHTML = year;
}
else {
	document.title = "Relationship Mapper is not ready for " + getParameterByName("company");
	document.getElementById('footer_text').innerHTML = getParameterByName("company");
        document.getElementById('footer_metric').innerHTML = metric.charAt(0).toUpperCase() + metric.slice(1);
        document.getElementById('footer_year').innerHTML = year;
	document.getElementById('hint').innerHTML = "";
	document.getElementsByClassName('loading_message').innerHTML = "Data is not available for this company in this proximity measure.";
}

// Tree 
function addTree(direction, id, msg_id, m) {
  var w = 1280 - m[1] - m[3],
    h = 700 - m[0] - m[2],
    i = 0,
    root;
var tree = d3.layout.tree()
    .size([h, w]);
var diagonal = d3.svg.diagonal()
    .projection(function(d) { return [d.y, d.x]; });
var vis = d3.select(id).append("svg:svg")
    .attr("width", w + m[1] + m[3])
    .attr("height", h + m[0] + m[2])
    // .on("wheel.zoom", true)
    // .attr("viewBox", "0,0,400,400")
  .append("svg:g")
    .attr("transform", "translate(" + m[3] + "," + m[0] + ")");
if (direction == "forward") {
  rootJsonFileName = getJsonFileName(getParameterByName("company"));
} else {
  // grab the JSON file associated with the backward tree
  rootJsonFileName = getJsonFileName(getParameterByName("company"));
  
}

d3.json(rootJsonFileName, function(json) {
//d3.json(appJsonFile, function(error, json) {
  console.log(json);
  root = json;
  for (var i in root.children){
    if(root.children[i] != undefined && root.children[i]) {
	    console.log(root.children[i]);
	    if( root.children[i].similarity < getParameterByName("similarity")){
	       console.log(root.children[i].similarity);
	       root.children.splice(i, 1);
	    }
    }
  }
  console.log(root.children.length);
  //console.log(rootJsonFileName);
  //console.log("root:", root);
  root.x0 = h / 2;
  root.y0 = 0;
  function toggleAll(d) {
    if (d.children) {
      d.children.forEach(toggleAll);
      toggle(d);
    }
  }
  // Initialize the display to show a few nodes.
  root.children.forEach(toggleAll);
  
  for(var i in root.children){
	toggle(root.children[i]);
  }
  //toggle(root.children[1].children[2]);
  //toggle(root.children[9]);
  //toggle(root.children[9].children[0]);
  update(tree, root, vis, diagonal, direction, w);
  // console.log("loading: " + document.getElementsByClassName('loading_message')[0].innerHTML);
  document.getElementById(msg_id).innerHTML = "";
});  
}
addTree("forward", "#body", "loading_message_1", [20, 120, 20, 120]);

function get_base_url(){
	var base_url = "";
	if (getParameterByName("metric") == "competition"){
		base_url = "./local.html?metric=competition&year="+year+"&company=";
	}
	else if (getParameterByName("metric") == "ownership"){
		base_url = "./local.html?metric=ownership&year="+year+"&company=";
	}
	else if (getParameterByName("metric") == "agreement"){
		base_url = "./local.html?metric=agreement&year="+year+"&company=";
	}
	else if (getParameterByName("metric") == "legal"){
		base_url = "./local.html?metric=legal&year="+year+"&company=";
  }
  else if (getParameterByName("metric") == "personal"){
		base_url = "./local.html?metric=personal&year="+year+"&company=";
	}
  else if (getParameterByName("metric") == "full"){
		base_url = "./local_full.html?metric=full&year="+year+"&company=";
	}
	else {
		base_url = "./local.html?app=";
	}
	return base_url;
}
function get_json_path(){
	var json_path = " ";
        if (getParameterByName("metric") == "competition"){
                json_path = "./json.competition/converted/";
        }
        else if (getParameterByName("metric") == "ownership"){
                json_path = "./json.ownership/converted/";
        }
        else if (getParameterByName("metric") == "agreement"){
                json_path = "./json.agreement/converted/";
        }
        else if (getParameterByName("metric") == "legal"){
                json_path = "./json.legal/converted/";
        }
        else if (getParameterByName("metric") == "personal"){
                json_path = "./json.personal/converted/";
        }
        else if (getParameterByName("metric") == "full"){
                json_path = "./json.full/converted/";
        }
        else {
                json_path = "./json/";
        }
        return json_path;
}
function fileExists(url)
{
    var http = new XMLHttpRequest();
    http.open('HEAD', url, false);
    http.send();    
    return http.status!=404;
}
function check_json_exists_target(){
        var base_url = get_base_url();
        var json_path = get_json_path();
        var url = json_path + getParameterByName("company") + ".json";
        //console.log(url);
        return fileExists(url);
}
function check_json_exists(d){
	var base_url = get_base_url();
	var json_path = get_json_path();
	var url = json_path + d.permalink + ".json";
	//console.log(url);
	return fileExists(url);
	/*
        // check if json file is ready
        $.ajax({
                url: json_path + d.id + ".json",
                success: function(data){
			json_exist = 1;
			console.log("data exists for " + d.name);
                },
                error: function(data){
			json_exist = 0;
			console.log("no data for " + d.name);
                },
        })
	return json_exist;
	*/
}
function change_root(d, i){
	if (d.permalink == getParameterByName("company")){
		return;
	}
	var base_url = get_base_url();
	var json_path = get_json_path();
	var url = json_path + d.permalink + ".json";
	if (fileExists(url)){
		window.location.href = base_url + d.permalink;
		/*
		var answer = confirm("You want to move to AppMap for " + d.name + "?");
		if (answer) {
			//alert("Moving to AppMap for " + d.name);
			window.location.href = base_url + d.permalink;
		}
		*/
	}
	else{
		console.log("no data for " + d.name);
	}
	/*
        $.ajax({
                url: json_path + d.permalink + ".json",
                success: function(data){
			var answer = confirm("You want to move to AppMap for " + d.name + "?");
			if (answer) {
				//alert("Moving to AppMap for " + d.name);
				window.location.href = base_url + d.permalink;
			}
                },
                error: function(data){
                        console.log("no data for " + d.name);
                },
        })
	*/
}
function update(tree, source, vis, diagonal, direction, w) {
  var duration = d3.event && d3.event.altKey ? 5000 : 500;
  var i = 0;
  // Compute the new tree layout.
  var nodes = tree.nodes(source).reverse();
  // Normalize for fixed-depth.
  if (direction == "backward") {
    // doing d.y = w - (d.depth * 400); }); flips the tree horizontally
    nodes.forEach(function(d) { d.y = w - (d.depth * 400); });
  } else {
    nodes.forEach(function(d) { d.y = (d.depth * 400); });
  }
  

  // Update the nodesâ¦
  var node = vis.selectAll("g.node")
      .data(nodes, function(d) { return d.id || (d.id = ++i); });
  // Enter any new nodes at the parent's previous position.
  var nodeEnter = node.enter().append("svg:g")
      .attr("class", "node")
      .attr("transform", function(d) { return "translate(" + source.y0 + "," + source.x0 + ")"; })
      .on("click", change_root)
      //.on("dblclick", change_root)
      //.on("click", function(d) { toggle(d); update(d); });
      ;
  //console.log(d_children);
  nodeEnter.append("svg:circle")
      .attr("r", 1e-6)
      //.style("fill", function(d) { 
        //return d._children ? "lightsteelblue" : "#fff"; })
      .style("fill", function(d) {
          if(d.relationship == "competition") return "salmon";
          if(d.relationship == "ownership") return "mediumseagreen";
          if(d.relationship == "legal") return "cornflowerblue";
          if(d.relationship == "personal") return "gold";
          if(d.relationship == "agreement") return "plum";
        })
      ;
  nodeEnter.append("svg:text")
      .attr("x", function(d) { return d.children || d._children ? -10 : 10; })
      .attr("dy", ".35em")
      .attr("text-anchor", function(d) { return d.children || d._children ? "end" : "start"; })
      .text(function(d) { return d.name; })
      .style("fill", function(d) {
          return check_json_exists(d) ? "steelblue" : "black";})
      .style("fill-opacity", 1e-6);


  // Transition nodes to their new position.
  var nodeUpdate = node.transition()
      .duration(duration)
      .attr("transform", function(d) { return "translate(" + d.y + "," + d.x + ")"; });
  nodeUpdate.select("circle")
      .attr("r", 4.5)
      //.style("fill", function(d) { return d._children ? "lightsteelblue" : "#fff"; })
      .style("fill", function(d) {
          if(d.relationship == "competition") return "salmon";
          if(d.relationship == "ownership") return "mediumseagreen";
          if(d.relationship == "legal") return "cornflowerblue";
          if(d.relationship == "personal") return "gold";
          if(d.relationship == "agreement") return "plum";
        })
      //.style("fill", function(d) { return check_json_exists(d) ? "lightsteelblue" : "#fff"; })
      ;
  nodeUpdate.select("text")
      .style("fill-opacity", 1);

  
  // Transition exiting nodes to the parent's new position.
  var nodeExit = node.exit().transition()
      .duration(duration)
      .attr("transform", function(d) { return "translate(" + source.y + "," + source.x + ")"; })
      .remove();
  nodeExit.select("circle")
      .attr("r", 1e-6);
  nodeExit.select("text")
      .style("fill-opacity", 1e-6);
  // Update the linksâ¦
  var link = vis.selectAll("path.link")
      .data(tree.links(nodes), function(d) { return d.target.id; });
  // Enter any new links at the parent's previous position.
  link.enter().insert("svg:path", "g")
      .attr("class", "link")
      .attr("d", function(d) {
        var o = {x: source.x0, y: source.y0};
        return diagonal({source: o, target: o});
      })
    .transition()
      .duration(duration)
      .attr("d", diagonal);
  // Transition links to their new position.
  link.transition()
      .duration(duration)
      .attr("d", diagonal);
  // Transition exiting nodes to the parent's new position.
  link.exit().transition()
      .duration(duration)
      .attr("d", function(d) {
        var o = {x: source.x, y: source.y};
        return diagonal({source: o, target: o});
      })
      .remove();
  // Stash the old positions for transition.
  nodes.forEach(function(d) {
    d.x0 = d.x;
    d.y0 = d.y;
  });
}
// Toggle children.
function toggle(d) {
  if (d.children) {
    d._children = d.children;
    d.children = null;
    //console.log("collapse:" + d.name);
  } else {
    d.children = d._children;
    d._children = null;
    //console.log("expand:" + d.name);
  }
}

// Returns an array of the valid years for the company
function myAjax (callback) {
  var comp_name = getParameterByName("company");
  var results;

  $.ajax( { type : 'POST',
    data : {'company': comp_name},
    url  : 'get_years.php',              // <=== CALL THE PHP FUNCTION HERE.
    success: function ( data ) {
      // alert( data );               // <=== VALUE RETURNED FROM FUNCTION.
      results = jQuery.parseJSON(data);       
      callback(results);
    },
    error: function ( xhr ) {
      alert( "error" );
    }
  });
}

function populateYearMenu(years) {

  // https://stackoverflow.com/questions/27769763/populating-a-html-dropdown-menu-through-a-javascript-function
  // https://developer.mozilla.org/en-US/docs/Web/API/Document/createElement
  var dropdown = document.getElementById("year-menu");
  // console.log("dropdown" + dropdown);
  var i, newOption, newLink, newLink;

  // first need to clear out the dropdown or else subsequent clicks
  // will cause the list to be too long
  while (dropdown.firstChild) {
    dropdown.removeChild(dropdown.firstChild);
  }
  
  for (i = 0; i < years.length; i++) {
      newOption = document.createElement("li");
      // newOption.textContent = years[i];
      newLink = document.createElement("a");
      newLink.textContent = years[i];
      newLink.href = "./local_full.html?metric=full&year=" + years[i] + "&company=" + getParameterByName("company");
      newOption.appendChild(newLink);
      dropdown.appendChild(newOption);
  }
}


$(function() {


var people = [];
// console.log("json path:" + get_json_path() + year + "/" + getParameterByName("company"));
$.getJSON(get_json_path() + year + "/" + getParameterByName("company") + ".json", function(data) {   
  //  console.log("length: " + data.children.length);
   var children_text = "";
   tbody = $('<tbody>');
   $(tbody).appendTo("#userdata");
       for (var i = 0; i < data.children.length; i++) {
         tr = $('<tr/>');
         tr.append("<td>" + data.name + "</td>");
         tr.append("<td>" + data.year + "</td>");
                    
         // children_text = children_text + data.children[i].name + ", ";
         tr.append("<td>" + data.children[i].name + "</td>");
         // tr.append("<td>" + data.children[i].item + "</td>");
         children_text = children_text.substring(0, children_text.length-2); 
         
         $('table').append(tr);
         $(tr).appendTo("#userdata");
         
       }
    tbody = $('</tbody>');
    $(tbody).appendTo("#userdata");
       // var tblRow = "<tr>" + "<td>" + f.name + "</td>" +
       //  "<td>" + f.year + "</td>" + "<td>" + f.children + "</td>" + "</tr>"
       //  $(tblRow).appendTo("#userdata tbody");
  });

});

;

    </script>

    <div class="scrolltable">
      <table id= "userdata" class="tableSection" border="2">
        <thead>
                  <th>name</th>
                  <th>year</th>
                  <th>children</th>
                  <th>item</th>
              </thead>
      </table>
    </div>
    <div id="bottomTree">
      <h2 align="center" id="loading_message_2">Data is loading... </h2>
      <div id="footer">
      </div>
    </div>
    <script type="text/javascript">
      addTree("backward", "#bottomTree", "loading_message_2",
        [20, 700, 20, 120]);
    </script>
  </body>
  
</html>
